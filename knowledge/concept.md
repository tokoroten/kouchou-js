## 概要

このアプリケーションは、Talk to the city、広聴AIをJavaScript単体で動作するように再実装したものです。

https://github.com/AIObjectives/talk-to-the-city-reports
https://github.com/digitaldemocracy2030/kouchou-ai

ブラウザ上のSPAとして動作し、サーバを不要にすることで、ポータビリティとセキュリティの向上を図っています。
大量の市民意見を効率的に分析・可視化し、政策決定者や研究者にとって有用なインサイトを提供します。

## 技術スタック

### フロントエンド
- **TypeScript** (v5.x): 型安全性の確保
- **React** (v18.x): UI構築
- **Zustand**: 軽量状態管理
- **Tailwind CSS**: ユーティリティファーストCSS
- **Vite**: 高速ビルドツール

### データ処理・分析
- **OpenAI API**: エンベディング生成、テキスト要約
- **UMAP-js**: 高次元データの低次元可視化
- **K-means**: クラスタリングアルゴリズム
- **plotly.js**: インタラクティブなデータ可視化

### データ永続化・非同期処理
- **IndexedDB**: ブラウザ内データストレージ
- **Web Workers**: CPU集約的処理の非同期実行
- **Papa Parse**: CSV解析ライブラリ

### 開発環境
- **Node.js** (v20.x)
- **ESLint**: コード品質管理
- **Prettier**: コードフォーマッタ

## アプリケーションの動作の流れ

### 1. セッション管理
- **セッション初期化**: 新しい分析開始時にUUIDを生成し、セッションを開始
- **永続化**: セッション状態はIndexedDBで永続化され、ブラウザを閉じても継続可能
- **マルチセッション**: 複数の分析セッションを並行して管理
- **モデル共有**: 過去のセッションからUMAPモデルを再利用し、一貫した可視化を実現

### 2. データ入力・前処理
- **CSVアップロード**: 
  - 意見データと発言者属性を含むCSVファイルの処理
  - 必須カラム: `opinion`（意見内容）
  - オプションカラム: `age`, `gender`, `region`, `category` など
- **データ検証**: 
  - アップロード時にデータ形式とカラム構造を自動検証
  - エラー詳細の表示と修正提案
- **プレビュー機能**: アップロード後にデータ内容とサンプルを表示

### 3. 意見処理パイプライン（Web Worker実行）

### 3. 意見処理パイプライン（Web Worker実行）

#### 3.1 発言の成形
- **目的**: 生データから構造化された意見を抽出
- **処理**: OpenAI APIを使用して意見を正規化・分割
- **効果**: エンベディング処理の品質向上とノイズ除去

#### 3.2 意見のエンベディング
- **モデル**: OpenAI text-embedding-3-small
- **バッチ処理**: APIレート制限を考慮した効率的な処理
- **キャッシュ**: 同一意見の再計算を避けるためのハッシュベースキャッシュ

#### 3.3 次元削減（UMAP）
- **設定可能パラメータ**:
  - `n_neighbors`: 近傍数（デフォルト: 15）
  - `min_dist`: 最小距離（デフォルト: 0.1）
  - `n_components`: 出力次元（固定: 2）
- **モデル再利用**: 学習済みUMAPモデルの保存・読み込み機能
- **インクリメンタル処理**: 新データの追加時の効率的な処理

#### 3.4 クラスタリング（K-means）
- **動的クラスタ数決定**: エルボー法による最適クラスタ数の自動推定
- **ユーザー設定**: 手動でのクラスタ数指定も可能
- **安定性**: 複数回実行による結果の安定化

#### 3.5 意見の表札化と要約
- **代表意見選出アルゴリズム**:
  1. クラスタ重心に最も近い意見を選出
  2. 既存選出意見から最も遠い意見を追加選出
  3. n回繰り返し（デフォルト: n=5）
- **階層的要約**:
  - クラスタレベル: 代表意見から概念とラベルを生成
  - 全体レベル: 各クラスタ要約を統合した総括を生成

### 4. 可視化・エクスポート

#### 4.1 インタラクティブ可視化
- **plotly.js使用**: ズーム、パン、ホバー情報
- **カラーマッピング**: クラスタ別の色分け
- **アノテーション**: クラスタ重心にラベル表示
- **フィルタリング**: 属性による動的フィルタ機能

#### 4.2 レポート生成
- **HTML出力**: スタンドアロンで動作する完全なレポート
- **CSV出力**: 分析結果の数値データ
- **設定の保存**: 分析パラメータの再現可能性確保

## 技術的詳細

### Web Worker活用戦略
各処理ステップを独立したWorkerで実行し、UIの応答性を維持：

```
Main Thread              Worker Threads
     │                        │
     ├── UI Management         ├── CSV Parser Worker
     ├── State Management      ├── LLM Processing Worker  
     ├── Visualization         ├── Embedding Worker
     └── IndexedDB Access      ├── UMAP Worker
                              └── Clustering Worker
```

各Workerは処理完了時にIndexedDBに結果を保存し、メインスレッドに通知します。

### データ永続化戦略
- **セッション管理**: UUID別のセッションテーブル
- **段階的保存**: 各処理ステップの結果をインクリメンタルに保存
- **モデル共有**: UMAPモデルのシリアライゼーションと再利用
- **キャッシュ最適化**: エンベディングのハッシュベースキャッシュ

### エラーハンドリング・信頼性
- **段階的復旧**: 途中で中断された処理の継続機能
- **API制限対応**: OpenAI APIのレート制限とエラー時のリトライ機能
- **データ検証**: 各段階でのデータ整合性チェック
- **ログ機能**: デバッグとエラー追跡のための詳細ログ

## ユーザーインターフェース設計

### 画面構成
1. **ダッシュボード**: セッション一覧と進行状況の概要
2. **アップロード画面**: CSV入力とデータプレビュー
3. **設定画面**: API設定とパラメータ調整
4. **処理画面**: リアルタイム進行状況とログ表示
5. **可視化画面**: インタラクティブな結果表示
6. **エクスポート画面**: レポート生成とダウンロード

### UX配慮事項
- **進行状況の可視化**: 各処理ステップの詳細な進捗表示
- **中断・再開**: 長時間処理の柔軟な管理
- **プリセット機能**: よく使用される設定の保存・読み込み
- **レスポンシブ対応**: デスクトップ・タブレットでの最適表示

## パフォーマンス最適化

### 処理効率化
- **バッチ処理**: API呼び出しの効率的なグループ化
- **並列処理**: 独立した処理の並列実行
- **メモリ管理**: 大容量データのストリーミング処理
- **プログレッシブ表示**: 結果の段階的な表示更新

### スケーラビリティ
- **データサイズ制限**: 推奨データサイズとワーニング機能
- **動的リソース調整**: 利用可能メモリに応じた処理調整
- **バックグラウンド処理**: タブを閉じても継続する処理機能

